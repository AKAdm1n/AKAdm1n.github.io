<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whitelist Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container">
        <!-- Login Form -->
        <div id="loginForm">
            <h2>Login</h2>
            <input type="text" id="loginUsername" placeholder="Enter username" class="form-control mb-2" />
            <input type="password" id="loginPassword" placeholder="Enter password" class="form-control mb-2" />
            <button id="loginButton" class="btn btn-primary">Login</button>
            <p id="loginError" class="text-danger mt-2" style="display: none;">Invalid username or password</p>
        </div>

        <!-- Whitelist Management Section -->
        <div id="whitelistManagement" style="display: none;">
            <h1>Whitelist Management</h1>
            <input type="text" id="username" placeholder="Enter username" class="form-control mb-2" />
            <button id="addButton" class="btn btn-primary">Add to Whitelist</button>
            <button id="combineDownloadButton" class="btn btn-success">Download Script</button>

            <h2>Current Whitelisted Users</h2>
            <ul id="whitelistUsers" class="list-group"></ul>
        </div>
    </div>

    <script>
        const loginButton = document.getElementById('loginButton');
        const loginUsername = document.getElementById('loginUsername');
        const loginPassword = document.getElementById('loginPassword');
        const loginError = document.getElementById('loginError');
        const loginForm = document.getElementById('loginForm');
        const whitelistManagement = document.getElementById('whitelistManagement');

        // Hardcoded login credentials
        const correctUsername = "admin";
        const correctPassword = "lunda";

        // Login validation
        loginButton.onclick = function () {
            const username = loginUsername.value.trim();
            const password = loginPassword.value.trim();

            if (username === correctUsername && password === correctPassword) {
                loginForm.style.display = "none"; // Hide login form
                whitelistManagement.style.display = "block"; // Show whitelist management section
            } else {
                loginError.style.display = "block"; // Show error message
            }
        };

        // Whitelist management script (no changes here)
        const whitelistUsers = document.getElementById('whitelistUsers');
        const usernameInput = document.getElementById('username');

        // Fetch current whitelisted users and display them
        fetch('https://b9147066-c15a-4ff8-aa2e-0c3587462bab-00-3taxu2quvjj99.janeway.replit.dev/whitelist')
            .then(response => response.json())
            .then(data => {
                data.forEach(user => {
                    const li = document.createElement('li');
                    li.textContent = user;
                    whitelistUsers.appendChild(li);
                });
            });

        // Send notification to the Discord webhook
        const sendWebhookNotification = (username) => {
            const webhookUrl = 'https://discord.com/api/webhooks/1290534920212447352/4cflaYP0zex14ZM8ZsQnP_PHBTsx47UD-6JG5ZbnBd0QjXmUMe0EmVuPlz-N2csGgrbF';
            const message = {
                content: `User **${username}** has been whitelisted.`
            };

            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(message)
            }).then(response => {
                if (!response.ok) {
                    console.error('Failed to send webhook notification');
                }
            });
        };

        // Add username to the whitelist and notify via webhook
        const addUsernameToWhitelist = () => {
            const username = usernameInput.value.trim();
            if (username) {
                fetch('https://b9147066-c15a-4ff8-aa2e-0c3587462bab-00-3taxu2quvjj99.janeway.replit.dev/whitelist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username })
                })
                .then(response => {
                    if (response.ok) {
                        const li = document.createElement('li');
                        li.textContent = username;
                        whitelistUsers.appendChild(li);
                        usernameInput.value = '';
                        // Call webhook notification
                        sendWebhookNotification(username);
                    } else {
                        alert('Failed to add user to whitelist');
                    }
                });
            }
        };

        // Attach event listeners
        document.getElementById('addButton').onclick = addUsernameToWhitelist;

        usernameInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                addUsernameToWhitelist();
            }
        });

        // Combine and download the script
        document.getElementById('combineDownloadButton').onclick = async () => {
            const response = await fetch('https://cdn.discordapp.com/attachments/781966227157286924/1290482994531799070/combinedFile.txt?ex=66fc9f71&is=66fb4df1&hm=ba5162ecf6031e9fb5bbef5f7947a2f234e198f4b04dd6d81d6f45935c960b85&');
            const existingContent = await response.text(); 

            const whitelistResponse = await fetch('https://b9147066-c15a-4ff8-aa2e-0c3587462bab-00-3taxu2quvjj99.janeway.replit.dev/whitelist');
            const users = await whitelistResponse.json();
            const luaTable = `local whitelistedPlayers = {\n${users.map(user => `  "${user}",`).join('\n')}\n}\n\n`;
            const pluaTable = `local premiumUsers = {\n${users.map(user => `  "${user}",`).join('\n')}\n}\n\n`;

            const combinedContent = pluaTable + luaTable + existingContent;

            const blob = new Blob([combinedContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'combinedWhitelist.txt'; 
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
